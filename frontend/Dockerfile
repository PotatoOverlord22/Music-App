FROM node:20

RUN apt-get update && apt-get upgrade -y && apt-get clean

WORKDIR /app

COPY ./package.json ./package-lock.json ./
RUN npm install

COPY . .

# Declare all build-time environment variables
ARG VITE_AUTH_CLIENTID
ARG VITE_TENANT_ID
ARG VITE_AUTH0_DOMAIN
ARG VITE_AUTH0_CLIENT_ID
ARG VITE_AUTH0_CLIENT_SECRET
ARG VITE_AUTH0_AUDIENCE
ARG VITE_API_URL

# Export them so Vite sees them during build
ENV VITE_AUTH_CLIENTID=$VITE_AUTH_CLIENTID
ENV VITE_TENANT_ID=$VITE_TENANT_ID
ENV VITE_AUTH0_DOMAIN=$VITE_AUTH0_DOMAIN
ENV VITE_AUTH0_CLIENT_ID=$VITE_AUTH0_CLIENT_ID
ENV VITE_AUTH0_CLIENT_SECRET=$VITE_AUTH0_CLIENT_SECRET
ENV VITE_AUTH0_AUDIENCE=$VITE_AUTH0_AUDIENCE
ENV VITE_API_URL=$VITE_API_URL

RUN npm run build

EXPOSE 4173
CMD ["npm", "run", "preview"]